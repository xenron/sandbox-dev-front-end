/*! Rappid v1.7.1 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2016-03-03 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.layout.ForceDirected=Backbone.Model.extend({defaults:{linkDistance:10,linkStrength:1,charge:10},initialize:function(a){this.elements=this.get("graph").getElements(),this.links=this.get("graph").getLinks(),this.cells=this.get("graph").get("cells"),this.width=this.get("width"),this.height=this.get("height"),this.gravityCenter=this.get("gravityCenter"),this.t=1,this.energy=1/0,this.progress=0},start:function(){var a=this.get("width"),b=this.get("height");_.each(this.elements,function(c){c.set("position",{x:Math.random()*a,y:Math.random()*b}),c.charge=c.get("charge")||this.get("charge"),c.weight=c.get("weight")||1;var d=c.get("position");c.x=d.x,c.y=d.y,c.px=c.x,c.py=c.y,c.fx=0,c.fy=0},this),_.each(this.links,function(a){a.strength=a.get("strength")||this.get("linkStrength"),a.distance=a.get("distance")||this.get("linkDistance"),a.source=this.cells.get(a.get("source").id),a.target=this.cells.get(a.get("target").id)},this)},step:function(){if(.99*this.t<.005)return this.notifyEnd();var a=this.width,b=this.height,c=.1,d=this.gravityCenter,e=this.energy;this.energy=0;var f,g,h=0,i=0,j=0,k=0,l=this.elements.length,m=this.links.length;for(f=0;l-1>f;f++){var n=this.elements[f];for(h+=n.x,i+=n.y,g=f+1;l>g;g++){var o=this.elements[g],p=o.x-n.x,q=o.y-n.y,r=p*p+q*q,s=Math.sqrt(r),t=this.t*n.charge/r,u=t*p,v=t*q;n.fx-=u,n.fy-=v,o.fx+=u,o.fy+=v,this.energy+=u*u+v*v}}for(h+=this.elements[l-1].x,i+=this.elements[l-1].y,f=0;m>f;f++){var w=this.links[f],n=w.source,o=w.target,p=o.x-n.x,q=o.y-n.y,r=p*p+q*q,s=Math.sqrt(r),x=this.t*w.strength*(s-w.distance)/s,u=x*p,v=x*q,y=n.weight/(n.weight+o.weight);n.x+=u*(1-y),n.y+=v*(1-y),o.x-=u*y,o.y-=v*y,this.energy+=u*u+v*v}for(f=0;l>f;f++){var z=this.elements[f],A={x:z.x,y:z.y};d&&(A.x+=(d.x-A.x)*this.t*c,A.y+=(d.y-A.y)*this.t*c),A.x+=z.fx,A.y+=z.fy,A.x=Math.max(0,Math.min(a,A.x)),A.y=Math.max(0,Math.min(b,A.y));var B=.9;A.x+=(z.px-A.x)*B,A.y+=(z.py-A.y)*B,z.px=A.x,z.py=A.y,z.fx=z.fy=0,z.x=A.x,z.y=A.y,j+=z.x,k+=z.y,this.notify(z,f,A)}this.t=this.cool(this.t,this.energy,e);var C=h-j,D=i-k,E=Math.sqrt(C*C+D*D);1>E&&this.notifyEnd()},cool:function(a,b,c){return c>b?(this.progress+=1,this.progress>=5?(this.progress=0,a/.99):a):(this.progress=0,.99*a)},notify:function(a,b,c){a.set("position",c)},notifyEnd:function(){this.trigger("end")}});