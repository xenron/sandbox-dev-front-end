/*! Rappid v1.7.1 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2016-03-03 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.Inspector=joint.mvc.View.extend({className:"inspector",options:{cellView:void 0,cell:void 0,live:!0,validateInput:function(a,b,c){return a.validity?a.validity.valid:!0},renderFieldContent:void 0,operators:{},multiOpenGroups:!0},events:{mousedown:"startBatchCommand","change [data-attribute]:not([data-custom-field])":"onChangeInput","click .group-label":"onGroupLabelClick","click .btn-list-add":"addListItem","click .btn-list-del":"deleteListItem"},init:function(){this.options.groups=this.options.groups||{},_.bindAll(this,"stopBatchCommand"),$(document).on("mouseup",this.stopBatchCommand),this.widgets=[],this.flatAttributes=joint.util.flattenObject(this.options.inputs,"/",function(a){return a.type}),this._when={},this._bound={};var a=_.map(this.flatAttributes,function(a,b){if(a.when){var c={expression:a.when,path:b};_.each(this.extractExpressionPaths(c.expression),function(a){(this._when[a]||(this._when[a]=[])).push(c)},this)}return"select"==a.type&&_.isString(a.options)&&(this._bound[b]=a.options),a.path=b,a},this);this.groupedFlatAttributes=_.sortBy(_.sortBy(a,"index"),function(a){var b=this.options.groups[a.group];return b&&b.index||Number.MAX_VALUE},this),this.on("render",function(){var a={},b=[];_.each(this.$("[data-attribute]"),function(c){var d=$(c),e=d.attr("data-attribute");a[e]=d,b.push(e.substring(0,e.indexOf("/"))||e)},this),this._byPath=a,this._attributeKeys=_.uniq(b),_.each(this.$groups,function(a){var b=$(a),c=0===b.find("> .field:not(.hidden)").length;b.toggleClass("empty",c)})},this),this.listenTo(this.getModel(),"all",this.onCellChange,this)},getModel:function(){return this.options.cell||this.options.cellView.model},onCellChange:function(a,b,c,d){if(d=d||{},d.inspector!=this.cid)switch(a){case"remove":this.remove();break;case"change:position":this.updateInputPosition();break;case"change:size":this.updateInputSize();break;case"change:angle":this.updateInputAngle();break;case"change:source":case"change:target":case"change:vertices":break;default:var e="change:";if(a.slice(0,e.length)===e){var f=a.slice(e.length);_.contains(this._attributeKeys,f)&&this.render()}}},render:function(){this.$el.empty(),_.invoke(this.widgets,"remove");var a,b,c=[];return _.each(this.groupedFlatAttributes,function(d){if(a!==d.group){var e=this.options.groups[d.group];b=this.renderGroup({name:d.group,label:e&&e.label}),e&&e.closed?this.closeGroup(b,{init:!0}):this.openGroup(b,{init:!0}),c.push(b)}this.renderTemplate(b,d,d.path),a=d.group},this),this.$groups=c,this.$el.append(c),this.trigger("render"),this},getCellAttributeValue:function(a,b){var c=this.getModel(),d=joint.util.getByPath(c.attributes,a,"/");if(b=b||this.flatAttributes[a],!b)return d;if(_.isUndefined(d)&&!_.isUndefined(b.defaultValue)&&(d=b.defaultValue),b.valueRegExp){if(_.isUndefined(d))throw new Error("Inspector: defaultValue must be present when valueRegExp is used.");var e=d.match(new RegExp(b.valueRegExp));d=e&&e[2]}return d},resolveBindings:function(a){switch(a.type){case"select":var b=a.options||[];_.isString(b)&&(b=joint.util.getByPath(this.getModel().attributes,b,"/")||[]),_.isObject(b[0])||(b=_.map(b,function(a){return{value:a,content:a}})),a.items=b}},updateBindings:function(a){var b=_.reduce(this._bound,function(b,c,d){return 0==a.indexOf(c)&&b.push(d),b},[]);_.isEmpty(b)||(_.each(b,function(a){this.renderTemplate(null,this.flatAttributes[a],a,{replace:!0})},this),this.trigger("render"))},renderFieldContent:function(a,b,c){var d;if(_.isFunction(this.options.renderFieldContent)&&(d=this.options.renderFieldContent(a,b,c)))return $(d).attr({"data-attribute":b,"data-type":a.type,"data-custom-field":!0});var e,f,g,h;switch(a.type){case"select-box":f=_.findIndex(a.options,function(a){return a.value===c?!0:!(!_.isUndefined(a.value)||a.content!==c)}),e=new joint.ui.SelectBox(_.extend({},_.omit(a,"type","group","index"),{selected:f})),e.$el.attr({"data-attribute":b,"data-type":a.type}),e.render(),h=$("<label/>",{html:a.label||b}),d=$("<div/>").append(h,e.el),a.previewMode?(g=e.selection,e.on("options:mouseout close",function(){e.selection=g,this.processInput(e.$el,{previewCancel:!0,dry:!0})},this),e.on("option:hover",function(a,b){e.selection=a,this.processInput(e.$el,{dry:!0})},this),e.on("option:select",function(a,b){var c=_.isUndefined(g)?void 0:e.getSelectionValue(g),d=e.getSelectionValue(a),f=c===d;this.processInput(e.$el,{previewDone:!0,dry:f,originalValue:c}),g=a},this)):e.on("option:select",function(a,b){this.processInput(e.$el)},this),this.widgets.push(e);break;case"color-palette":f=_.findIndex(a.options,function(a){return a.value===c?!0:!(!_.isUndefined(a.value)||a.content!==c)}),e=new joint.ui.ColorPalette(_.extend({},_.omit(a,"type","group","index"),{selected:f})),e.$el.attr({"data-attribute":b,"data-type":a.type}),e.render(),h=$("<label/>",{html:a.label||b}),d=$("<div/>").append(h,e.el),a.previewMode?(g=e.selection,e.on("options:mouseout close",function(){e.selection=g,this.processInput(e.$el,{previewCancel:!0,dry:!0})},this),e.on("option:hover",function(a,b){e.selection=a,this.processInput(e.$el,{dry:!0})},this),e.on("option:select",function(a,b){var c=_.isUndefined(g)?void 0:e.getSelectionValue(g),d=e.getSelectionValue(a),f=c===d;this.processInput(e.$el,{previewDone:!0,dry:f,originalValue:c}),g=a},this)):e.on("option:select",function(a,b){this.processInput(e.$el)},this),this.widgets.push(e);break;case"select-button-group":a.multi?(f=[],_.each(a.options,function(a,b){_.contains(c,_.isUndefined(a.value)?a.content:a.value)&&f.push(b)})):f=_.findIndex(a.options,function(a){return a.value===c?!0:!(!_.isUndefined(a.value)||a.content!==c)}),e=new joint.ui.SelectButtonGroup(_.extend({},_.omit(a,"type","group","index"),{selected:f})),e.$el.attr({"data-attribute":b,"data-type":a.type}),e.render(),h=$("<label/>",{html:a.label||b}),d=$("<div/>").append(h,e.el),a.previewMode?(g=e.selection,e.on("mouseout",function(){e.selection=g,this.processInput(e.$el,{previewCancel:!0,dry:!0})},this),e.on("option:hover",function(b,c){a.multi?e.selection=_.uniq(e.selection.concat([b])):e.selection=b,this.processInput(e.$el,{dry:!0})},this),e.on("option:select",function(a,b){var c=_.isUndefined(g)?void 0:e.getSelectionValue(g),d=e.getSelectionValue(a),f=_.isEqual(c,d);this.processInput(e.$el,{previewDone:!0,dry:f,originalValue:c}),g=a},this)):e.on("option:select",function(a,b){this.processInput(e.$el)},this),this.widgets.push(e);break;default:d=this.renderOwnFieldContent({options:a,type:a.type,label:a.label||b,attribute:b,value:c})}return d},renderGroup:function(a){a=a||{};var b=$("<div/>").addClass("group").attr("data-name",a.name),c=$("<h3/>").addClass("group-label").text(a.label||a.name);return b.append(c)},renderOwnFieldContent:function(a){var b,c,d,e,f,g,h,i;switch(i=$("<label/>").text(a.label),a.type){case"number":c=$("<input/>",{type:"number",min:a.options.min,max:a.options.max,step:a.options.step}).val(a.value),b=[i,c];break;case"range":i.addClass("with-output"),e=$("<output/>").text(a.value),f=$("<span/>").addClass("units").text(a.options.unit),c=$("<input/>",{type:"range",name:a.type,min:a.options.min,max:a.options.max,step:a.options.step}).val(a.value),c.on("input",function(){e.text(c.val())}),b=[i,e,f,c];break;case"textarea":c=$("<textarea/>").text(a.value),b=[i,c];break;case"select":c=$("<select/>",{size:a.options.length}).prop("multiple",!!a.multiple),_.each(a.options.items,function(b){var d=$("<option/>",{value:b.value}).text(b.content);(b.value===a.value||_.contains(a.value,b.value))&&d.attr("selected","selected"),c.append(d)}),b=[i,c];break;case"toggle":g=$("<span><i/></span>"),c=$("<input/>",{type:"checkbox"}).prop("checked",!!a.value),d=$("<div/>").addClass(a.type),b=[i,d.append(c,g)];break;case"color":c=$("<input/>",{type:"color"}).val(a.value),b=[i,c];break;case"text":c=$("<input/>",{type:"text"}).val(a.value),b=[i,c];break;case"object":c=$("<div/>"),h=$("<div/>").addClass("object-properties"),b=[i,c.append(h)];break;case"list":g=$("<button/>").addClass("btn-list-add").text(a.options.addButtonLabel||"+"),h=$("<div/>").addClass("list-items"),c=$("<div/>"),b=[i,c.append(g,h)]}return c&&c.addClass(a.type).attr({"data-type":a.type,"data-attribute":a.attribute}),$.fn.append.apply($("<div>"),b).children()},renderObjectProperty:function(a){a=a||{};var b=$("<div/>",{"data-property":a.property,"class":"object-property"});return b},renderListItem:function(a){a=a||{};var b=$("<button/>").addClass("btn-list-del").text(a.options.removeButtonLabel||"-"),c=$("<div/>",{"data-index":a.index,"class":"list-item"});return c.append(b)},renderFieldContainer:function(a){a=a||{};var b=$("<div/>",{"data-field":a.path,"class":"field"});return b},renderTemplate:function(a,b,c,d){a=a||this.$el,d=d||{},this.resolveBindings(b);var e=this.renderFieldContainer({path:c});b.when&&!this.isExpressionValid(b.when)&&(e.addClass("hidden"),b.when.otherwise&&b.when.otherwise.unset&&this.unsetProperty(c));var f=this.getCellAttributeValue(c,b),g=this.renderFieldContent(b,c,f);if(e.append(g),joint.util.setAttributesBySelector(e,b.attrs),"list"===b.type)_.each(f,function(a,d){var e=this.renderListItem({index:d,options:b});this.renderTemplate(e,b.item,c+"/"+d),g.children(".list-items").append(e)},this);else if("object"===b.type){b.flatAttributes=joint.util.flattenObject(b.properties,"/",function(a){return a.type});var h=_.map(b.flatAttributes,function(a,b){return a.path=b,a});h=_.sortBy(h,function(a){return a.index}),_.each(h,function(a){var b=this.renderObjectProperty({property:a.path});this.renderTemplate(b,a,c+"/"+a.path),g.children(".object-properties").append(b)},this)}d.replace?a.find('[data-field="'+c+'"]').replaceWith(e):a.append(e)},updateInputPosition:function(){var a=this._byPath["position/x"],b=this._byPath["position/y"],c=this.getModel().get("position");a&&a.val(c.x),b&&b.val(c.y)},updateInputSize:function(){var a=this._byPath["size/width"],b=this._byPath["size/height"],c=this.getModel().get("size");a&&a.val(c.width),b&&b.val(c.height)},updateInputAngle:function(){var a=this._byPath.angle,b=this.getModel().get("angle");a&&a.val(b)},validateInput:function(a,b,c){switch(a){case"select-box":case"color-palette":case"select-button-group":return!0;default:return this.options.validateInput(b,c,a)}},onChangeInput:function(a){this.processInput($(a.target))},processInput:function(a,b){var c=a.attr("data-attribute"),d=a.attr("data-type");if(this.validateInput(d,a[0],c)){this.options.live&&this.updateCell(a,c,b);var e=this.getFieldValue(a[0],d),f=this.parse(d,e,a[0]);this.trigger("change:"+c,f,a[0],b),this.updateDependants(c)}},updateDependants:function(a){_.each(this._when[a],function(a){var b=this._byPath[a.path],c=b.closest(".field"),d=c.hasClass("hidden"),e=this.isExpressionValid(a.expression);c.toggleClass("hidden",!e),a.expression.otherwise&&a.expression.otherwise.unset&&this.options.live&&(e?d&&this.updateCell(b,a.path):(this.unsetProperty(a.path),this.renderTemplate(null,this.flatAttributes[a.path],a.path,{replace:!0}),this.trigger("render")))},this)},unsetProperty:function(a,b){var c=this.getModel(),d=a.split("/"),e=_.first(d),f=d.slice(1).join("/");if(b=b||{},b.inspector=this.cid,b["inspector_"+this.cid]=!0,"attrs"==a)c.removeAttr(f,b);else if(a==e)c.unset(e,b);else{var g=_.merge({},c.get(e)),h=joint.util.unsetByPath(g,f,"/");c.set(e,h,b)}},getOptions:function(a){if(0!==a.length){var b=a.attr("data-attribute"),c=this.flatAttributes[b];if(!c){var d=a.parent().closest("[data-attribute]"),e=d.attr("data-attribute");c=this.getOptions(d);var f=b.replace(e+"/",""),g=c;c=g.item||g.flatAttributes[f],c.parent=g}return c}},updateCell:function(a,b,c){var d=this.getModel(),e={};a?e[b]=a:e=this._byPath,this.startBatchCommand(),this._tempListsByPath={},_.each(e,function(a,b){if(!a.closest(".field").hasClass("hidden")){var e,f,g=a.attr("data-type");switch(g){case"list":f=this.findParentListByPath(b),f?(e=b.substr(f.length+1),joint.util.setByPath(this._tempListsByPath[f],e,[],"/")):this._tempListsByPath[b]=[];break;case"object":break;default:if(!this.validateInput(g,a[0],b))return;var h=this.getFieldValue(a[0],g),i=this.parse(g,h,a[0]),j=this.getOptions(a);if(j.valueRegExp){var k=joint.util.getByPath(d.attributes,b,"/")||j.defaultValue;i=k.replace(new RegExp(j.valueRegExp),"$1"+i+"$3")}if(f=this.findParentListByPath(b),f&&this._tempListsByPath[f])return e=b.substr(f.length+1),void joint.util.setByPath(this._tempListsByPath[f],e,i,"/");this.setProperty(b,i,c),this.updateBindings(b)}}},this),_.each(this._tempListsByPath,function(a,b){this.setProperty(b,a,_.extend({rewrite:!0},c)),this.updateBindings(b)},this),this.stopBatchCommand()},findParentListByPath:function(a){for(var b,c,d=a.split("/"),e=0,f=d[e],g=this.flatAttributes[f];e<d.length-1&&(!g||"list"!==g.type);)g&&"object"===g.type&&(b=g.properties),c=d[++e],f+="/"+c,g=b?b[c]:this.flatAttributes[f];return f!==a?f:null},getFieldValue:function(a,b){if(_.isFunction(this.options.getFieldValue)){var c=this.options.getFieldValue(a,b);if(c)return c.value}var d=$(a);switch(b){case"select-box":case"color-palette":case"select-button-group":var e=d.data("view");return e.getSelectionValue();default:return d.val()}},setProperty:function(a,b,c){c=c||{},c.inspector=this.cid;var d=joint.dia.Cell.prototype.prop,e=this.getModel();c.previewDone&&d.call(e,a,c.originalValue,{rewrite:!0,silent:!0}),_.isUndefined(b)?joint.dia.Cell.prototype.removeProp.call(e,a,c):d.call(e,a,_.clone(b),c)},parse:function(a,b,c){switch(a){case"number":case"range":b=parseFloat(b);break;case"toggle":b=c.checked;break;default:b=b}return b},startBatchCommand:function(){this.inBatch||(this.inBatch=!0,this.getModel().trigger("batch:start",{batchName:"inspector",cid:this.cid}))},stopBatchCommand:function(){this.inBatch&&(this.getModel().trigger("batch:stop",{batchName:"inspector",cid:this.cid}),this.inBatch=!1)},addListItem:function(a){var b=$(a.target),c=b.closest("[data-attribute]"),d=c.attr("data-attribute"),e=this.getOptions(c),f=c.children(".list-items").children(".list-item").last(),g=0===f.length?-1:parseInt(f.attr("data-index"),10),h=g+1,i=this.renderListItem({index:h,options:e});this.renderTemplate(i,e.item,d+"/"+h),b.parent().children(".list-items").append(i),i.find("input:first").focus(),this.trigger("render"),this.options.live&&this.updateCell()},deleteListItem:function(a){var b=$(a.target).closest(".list-item");b.nextAll(".list-item").each(function(){var a=parseInt($(this).attr("data-index"),10),b=a-1;$(this).find("[data-field]").each(function(){$(this).attr("data-field",$(this).attr("data-field").replace("/"+a,"/"+b))}),$(this).find("[data-attribute]").each(function(){$(this).attr("data-attribute",$(this).attr("data-attribute").replace("/"+a,"/"+b))}),$(this).attr("data-index",b)}),b.remove(),this.trigger("render"),this.options.live&&this.updateCell()},onRemove:function(){_.invoke(this.widgets,"remove"),$(document).off("mouseup",this.stopBatchCommand)},onGroupLabelClick:function(a){a.preventDefault(),this.options.multiOpenGroups||this.closeGroups();var b=$(a.target).closest(".group");this.toggleGroup(b)},toggleGroup:function(a){var b=_.isString(a)?this.$('.group[data-name="'+a+'"]'):$(a);b.hasClass("closed")?this.openGroup(b):this.closeGroup(b)},closeGroup:function(a,b){b=b||{};var c=_.isString(a)?this.$('.group[data-name="'+a+'"]'):$(a);!b.init&&c.hasClass("closed")||(c.addClass("closed"),this.trigger("group:close",c.data("name"),b))},openGroup:function(a,b){b=b||{};var c=_.isString(a)?this.$('.group[data-name="'+a+'"]'):$(a);(b.init||c.hasClass("closed"))&&(c.removeClass("closed"),this.trigger("group:open",c.data("name"),b))},closeGroups:function(){_.each(this.$groups,this.closeGroup,this)},openGroups:function(){_.each(this.$groups,this.openGroup,this)},COMPOSITE_OPERATORS:["not","and","or","nor"],PRIMITIVE_OPERATORS:["eq","ne","regex","text","lt","lte","gt","gte","in","nin"],_isComposite:function(a){return _.intersection(this.COMPOSITE_OPERATORS,_.keys(a)).length>0},_isPrimitive:function(a){var b=_.keys(this.options.operators).concat(this.PRIMITIVE_OPERATORS);return _.intersection(b,_.keys(a)).length>0},_evalCustomPrimitive:function(a,b,c){return!!this.options.operators[a].apply(this,[this.getModel(),b].concat(c))},_evalPrimitive:function(a){return _.reduce(a,function(a,b,c){return _.reduce(b,function(a,b,d){var e=this.getCellAttributeValue(d);if(_.isFunction(this.options.operators[c]))return this._evalCustomPrimitive(c,e,b);switch(c){case"eq":return b==e;case"ne":return b!=e;case"regex":return new RegExp(b).test(e);case"text":return!b||_.isString(e)&&e.toLowerCase().indexOf(b)>-1;case"lt":return b>e;case"lte":return b>=e;case"gt":return e>b;case"gte":return e>=b;case"in":return _.contains(b,e);case"nin":return!_.contains(b,e);default:return a}},!1,this)},!1,this)},_evalExpression:function(a){return this._isPrimitive(a)?this._evalPrimitive(a):_.reduce(a,function(a,b,c){if("not"==c)return!this._evalExpression(b);var d=_.map(b,this._evalExpression,this);switch(c){case"and":return _.every(d);case"or":return _.some(d);case"nor":return!_.some(d);default:return a}},!1,this)},_extractVariables:function(a){return _.isArray(a)||this._isComposite(a)?_.reduce(a,function(a,b){return a.concat(this._extractVariables(b))},[],this):_.reduce(a,function(a,b){return _.keys(b)},[])},isExpressionValid:function(a){return a=_.omit(a,"otherwise","dependencies"),this._evalExpression(a)},extractExpressionPaths:function(a){var b=a&&a.dependencies||[];return a=_.omit(a,"otherwise","dependencies"),_.uniq(this._extractVariables(a).concat(b))}});