/*! Rappid v1.7.1 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2016-03-03 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.FreeTransform=joint.mvc.View.extend({className:"free-transform",events:{"mousedown .resize":"startResizing","mousedown .rotate":"startRotating","touchstart .resize":"startResizing","touchstart .rotate":"startRotating"},DIRECTIONS:["nw","n","ne","e","se","s","sw","w"],POSITIONS:["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"],options:{cellView:void 0,rotateAngleGrid:15,preserveAspectRatio:!1,minWidth:0,minHeight:0,maxWidth:1/0,maxHeight:1/0,allowOrthogonalResize:!0,allowRotation:!0},init:function(){this.options.cellView&&_.defaults(this.options,{cell:this.options.cellView.model,paper:this.options.cellView.paper,graph:this.options.cellView.paper.model}),_.bindAll(this,"update","remove","pointerup","pointermove"),joint.ui.FreeTransform.clear(this.options.paper),$(document.body).on("mousemove touchmove",this.pointermove),$(document).on("mouseup touchend",this.pointerup),this.listenTo(this.options.graph,"all",this.update),this.listenTo(this.options.graph,"reset",this.remove),this.listenTo(this.options.cell,"remove",this.remove),this.listenTo(this.options.paper,"blank:pointerdown",this.remove),this.listenTo(this.options.paper,"scale translate",this.update),this.options.paper.$el.append(this.el),joint.ui.FreeTransform.registerInstanceToPaper(this,this.options.paper)},renderHandles:function(){var a=$("<div/>").prop("draggable",!1),b=a.clone().addClass("rotate"),c=_.map(this.POSITIONS,function(b){return a.clone().addClass("resize").attr("data-position",b)});this.$el.empty().append(c,b)},render:function(){this.renderHandles(),this.$el.attr("data-type",this.options.cell.get("type")),this.$el.toggleClass("no-orthogonal-resize",this.options.preserveAspectRatio||!this.options.allowOrthogonalResize),this.$el.toggleClass("no-rotation",!this.options.allowRotation),this.update()},update:function(){var a=this.options.paper.viewport.getCTM(),b=this.options.cell.getBBox();b.x*=a.a,b.x+=a.e,b.y*=a.d,b.y+=a.f,b.width*=a.a,b.height*=a.d;var c=g.normalizeAngle(this.options.cell.get("angle")||0),d="rotate("+c+"deg)";this.$el.css({width:b.width+4,height:b.height+4,left:b.x-3,top:b.y-3,transform:d,"-webkit-transform":d,"-ms-transform":d});var e=Math.floor(c*(this.DIRECTIONS.length/360));if(e!=this._previousDirectionsShift){var f=this.DIRECTIONS.slice(e).concat(this.DIRECTIONS.slice(0,e));this.$(".resize").removeClass(this.DIRECTIONS.join(" ")).each(function(a,b){$(b).addClass(f[a])}),this._previousDirectionsShift=e}},calculateTrueDirection:function(a){var b=this.options.cell,c=g.normalizeAngle(b.get("angle")),d=this.POSITIONS.indexOf(a);return d+=Math.floor(c*(this.POSITIONS.length/360)),d%=this.POSITIONS.length,this.POSITIONS[d]},startResizing:function(a){a.stopPropagation(),this.options.graph.trigger("batch:start");var b=$(a.target).data("position"),c=this.calculateTrueDirection(b),d=0,e=0;_.each(b.split("-"),function(a){d={left:-1,right:1}[a]||d,e={top:-1,bottom:1}[a]||e});var f=this.toValidResizeDirection(b),h={"top-right":"bottomLeft","top-left":"corner","bottom-left":"topRight","bottom-right":"origin"}[f];this._initial={angle:g.normalizeAngle(this.options.cell.get("angle")||0),resizeX:d,resizeY:e,selector:h,direction:f,relativeDirection:b,trueDirection:c},this._action="resize",this.startOp(a.target)},toValidResizeDirection:function(a){return{top:"top-left",bottom:"bottom-right",left:"bottom-left",right:"top-right"}[a]||a},startRotating:function(a){a.stopPropagation(),this.options.graph.trigger("batch:start");var b=this.options.cell.getBBox().center(),c=this.options.paper.snapToGrid({x:a.clientX,y:a.clientY});this._initial={centerRotation:b,modelAngle:g.normalizeAngle(this.options.cell.get("angle")||0),startAngle:g.point(c).theta(b)},this._action="rotate",this.startOp(a.target)},pointermove:function(a){if(this._action){a=joint.util.normalizeEvent(a);var b=this.options.paper.snapToGrid({x:a.clientX,y:a.clientY}),c=this.options.paper.options.gridSize,d=this.options.cell,e=this._initial;switch(this._action){case"resize":var f=d.getBBox(),h=g.point(b).rotate(f.center(),e.angle),i=h.difference(f[e.selector]()),j=e.resizeX?i.x*e.resizeX:f.width,k=e.resizeY?i.y*e.resizeY:f.height;if(j=g.snapToGrid(j,c),k=g.snapToGrid(k,c),j=Math.max(j,this.options.minWidth||c),k=Math.max(k,this.options.minHeight||c),j=Math.min(j,this.options.maxWidth),k=Math.min(k,this.options.maxHeight),this.options.preserveAspectRatio){var l=f.width*k/f.height,m=f.height*j/f.width;l>j?k=m:j=l}f.width==j&&f.height==k||d.resize(j,k,{direction:e.direction,relativeDirection:e.relativeDirection,trueDirection:e.trueDirection,ui:!0});break;case"rotate":var n=e.startAngle-g.point(b).theta(e.centerRotation);d.rotate(g.snapToGrid(e.modelAngle+n,this.options.rotateAngleGrid),!0)}}},pointerup:function(a){this._action&&(this.stopOp(),this.options.graph.trigger("batch:stop"),delete this._action,delete this._initial)},onRemove:function(){$(document.body).off("mousemove touchmove",this.pointermove),$(document).off("mouseup touchend",this.pointerup),joint.ui.FreeTransform.unregisterInstanceFromPaper(this,this.options.paper)},startOp:function(a){a&&($(a).addClass("in-operation"),this._elementOp=a),this.$el.addClass("in-operation")},stopOp:function(){this._elementOp&&($(this._elementOp).removeClass("in-operation"),delete this._elementOp),this.$el.removeClass("in-operation")}},{instancesByPaper:{},clear:function(a){a.trigger("freetransform:create"),this.removeInstancesForPaper(a)},removeInstancesForPaper:function(a){_.invoke(this.getInstancesForPaper(a),"remove")},getInstancesForPaper:function(a){return this.instancesByPaper[a.cid]||{}},registerInstanceToPaper:function(a,b){this.instancesByPaper[b.cid]||(this.instancesByPaper[b.cid]={}),this.instancesByPaper[b.cid][a.cid]=a},unregisterInstanceFromPaper:function(a,b){this.instancesByPaper[b.cid]&&(this.instancesByPaper[b.cid][a.cid]=null)}});