/*! Rappid v1.7.1 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2016-03-03 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.SelectBox=joint.mvc.View.extend({className:"select-box",events:{"click .select-box-selection":"onToggle","click .select-box-option":"onSelect"},options:{options:[],width:void 0,openPolicy:"auto",target:"undefined"!=typeof document?document.body:null,keyboardNavigation:!0,selected:void 0,selectBoxOptionsClass:void 0,disabled:!1},init:function(){_.bindAll(this,"onOutsideClick","onOptionHover","onSelect","onKeydown","onOptionsMouseOut"),$(document).on("click.selectBox",this.onOutsideClick),this.options.keyboardNavigation&&$(document).on("keydown.selectBox",this.onKeydown),this.$el.data("view",this),_.isUndefined(this.options.selected)?this.selection=_.findWhere(this.options.options,{selected:!0})||this.options.options[0]:this.selection=this.options.options[this.options.selected]},render:function(){return this.$el.empty(),this.$selection=null,this.renderSelection(this.selection),this.options.width&&this.$el.css("width",this.options.width),this.options.disabled&&this.disable(),this.$el.append(this.$options),this},renderOptions:function(){this.removeOptions(),this.$options=$("<div/>",{"class":[this.className,"select-box-options"].join(" ")}),this.$options.addClass(this.options.selectBoxOptionsClass),this.$options.on("click.selectBox",".select-box-option",this.onSelect),this.$options.on("mouseover.selectBox",".select-box-option",this.onOptionHover),this.$options.on("mouseleave.selectBox",this.onOptionsMouseOut),this.options.width&&this.$options.css("width",this.options.width),_.each(this.options.options,function(a,b){var c=this.renderOption(a,b);this.$options.append(c),this.selection===a&&c.addClass("selected hover")},this),this.$target=$(this.options.target)},removeOptions:function(){this.$options&&this.$options.remove()},renderOption:function(a,b){var c=this.renderOptionContent(a);return c.addClass("select-box-option"),c.data("index",b),c},renderOptionContent:function(a){var b=$("<div/>",{"class":"select-box-option-content",html:a.content});return a.icon&&b.prepend($("<img/>",{"class":"select-box-option-icon",src:a.icon})),b},renderSelection:function(a){if(this.$selection||(this.$selection=$("<div/>",{"class":"select-box-selection"}),this.$el.append(this.$selection)),this.$selection.empty(),a){var b=this.renderOptionContent(a);this.$selection.append(b)}else if(this.options.placeholder){var c=$("<div/>",{"class":"select-box-placeholder",html:this.options.placeholder});this.$selection.append(c)}},getOptionIndex:function(a){return $(a).closest(".select-box-option").data("index")},onSelect:function(a){var b=this.getOptionIndex(a.target);this.select(b,{ui:!0})},onToggle:function(a){this.toggle()},markOptionHover:function(a){this.$options.find(".hover").removeClass("hover"),$(this.$options.find(".select-box-option")[a]).addClass("hover")},onOptionHover:function(a){var b=this.getOptionIndex(a.target);this.markOptionHover(b),this.trigger("option:hover",this.options.options[b],b)},onOutsideClick:function(a){!this.el.contains(a.target)&&this.$el.hasClass("opened")&&this.close()},onOptionsMouseOut:function(a){this.trigger("options:mouseout",a)},getSelection:function(){return this.selection},getSelectionValue:function(a){return a=a||this.selection,a&&(_.isUndefined(a.value)?a.content:a.value)},getSelectionIndex:function(){return _.findIndex(this.options.options,this.selection)},getOptionHoverIndex:function(){return this.$options.find(".select-box-option.hover").index()},select:function(a,b){this.selection=this.options.options[a],this.renderSelection(this.selection),this.trigger("option:select",this.selection,a,b),this.close()},selectByValue:function(a,b){for(var c=this.options.options||[],d=0;d<c.length;d++){var e=c[d];if(_.isUndefined(e.value)&&e.content===a)return this.select(d,b);if(!_.isUndefined(e.value)&&e.value===a)return this.select(d,b)}},isOpen:function(){return this.$el.hasClass("opened")},toggle:function(){this.isOpen()?this.close():this.open()},position:function(){var a=this.$(".select-box-selection"),b=a.outerHeight(),c=a.offset(),d=c.left,e=c.top,f=this.$options.outerHeight(),g={left:0,top:0};this.options.target!==document.body?(g=this.$target.offset(),g.width=this.$target.outerWidth(),g.height=this.$target.outerHeight(),g.left-=this.$target.scrollLeft(),g.top-=this.$target.scrollTop()):(g.width=$(window).width(),g.height=$(window).height());var h=d,i="auto",j=this.options.openPolicy;switch("selected"!==j||this.selection||(j="auto"),j){case"above":i=e-f;break;case"coverAbove":i=e-f+b;break;case"below":i=e+b;break;case"coverBelow":i=e;break;case"selected":var k=this.$options.find(".selected").position();i=e-k.top;break;default:var l=e-this.$target.scrollTop()+f>g.top+g.height;i=l?e-f+b:e}h-=g.left,i-=g.top,this.$options.css({left:h,top:i})},open:function(){this.isDisabled()||(this.renderOptions(),this.$options.appendTo(this.options.target),this.position(),this.$el.addClass("opened"))},close:function(){this.removeOptions(),this.$el.removeClass("opened"),this.trigger("close")},onRemove:function(){this.removeOptions(),$(document).off(".selectBox",this.onOutsideClick),this.options.keyboardNavigation&&$(document).off(".selectBox",this.onKeydown)},onKeydown:function(a){if(this.isOpen()){var b;switch(a.which){case 39:case 40:b=1;break;case 38:case 37:b=-1;break;case 13:var c=this.getOptionHoverIndex();return void(c>=0&&this.select(c));case 27:return this.close();default:return}a.preventDefault();var d=this.getOptionHoverIndex(),e=d+b,f=this.options.options;0>e&&(e=f.length-1),e>=f.length&&(e=0),this.markOptionHover(e),this.trigger("option:hover",this.options.options[e],e)}},isDisabled:function(){return this.$el.hasClass("disabled")},enable:function(){this.$el.removeClass("disabled")},disable:function(){this.close(),this.$el.addClass("disabled")}});