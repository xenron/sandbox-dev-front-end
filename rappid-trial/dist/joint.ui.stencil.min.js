/*! Rappid v1.7.1 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2016-03-03 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.Stencil=joint.mvc.View.extend({className:"stencil",events:{"click .group-label":"onGroupLabelClick","touchstart .group-label":"onGroupLabelClick","input .search":"onSearch"},options:{width:200,height:800},init:function(){this.setPaper(this.options.paperScroller||this.options.paper),this.graphs={},this.papers={},this.$groups={},_.bindAll(this,"onDrag","onDragEnd","onDropEnd"),$(document.body).on({"mousemove.stencil touchmove.stencil":this.onDrag,"mouseup.stencil touchend.stencil":this.onDragEnd}),this.onSearch=_.debounce(this.onSearch,200)},setPaper:function(a){var b=this.options;if(a instanceof joint.dia.Paper)b.paperScroller=null,b.paper=a,b.graph=a.model;else{if(!("function"==typeof joint.ui.PaperScroller&&a instanceof joint.ui.PaperScroller))throw new Error("Stencil: paper required");b.paperScroller=a,b.paper=a.options.paper,b.graph=a.options.paper.model}},renderContent:function(){return $("<div/>").addClass("content")},renderPaperDrag:function(){return $("<div/>").addClass("stencil-paper-drag")},renderSearch:function(){return $("<input/>",{type:"search",placeholder:"search"}).addClass("search")},renderElementsContainer:function(){return $("<div/>").addClass("elements")},renderGroup:function(a){a=a||{};var b=$("<div/>").addClass("group").attr("data-name",a.name).toggleClass("closed",!!a.closed),c=$("<h3/>").addClass("group-label").text(a.label||a.name),d=this.renderElementsContainer();return b.append(c,d)},render:function(){this.$content=this.renderContent(),this.$paperDrag=this.renderPaperDrag(),this.$el.empty().append(this.$paperDrag,this.$content),this.options.search&&this.$el.addClass("searchable").prepend(this.renderSearch());var a={width:this.options.width,height:this.options.height,interactive:!1};if(this.options.groups){var b=_.sortBy(_.pairs(this.options.groups),function(a){return a[1].index});_.each(b,function(b){var c=b[0],d=b[1],e=this.$groups[c]=this.renderGroup({name:c,label:d.label,closed:d.closed}).appendTo(this.$content),f=new joint.dia.Graph,g=new joint.dia.Paper(_.extend({},a,{el:e.find(".elements"),model:f,width:d.width||a.width,height:d.height||a.height}));this.graphs[c]=f,this.papers[c]=g},this)}else{var c=this.renderElementsContainer().appendTo(this.$content),d=new joint.dia.Graph,e=new joint.dia.Paper(_.extend(a,{el:c,model:d}));this.graphs.__default__=d,this.papers.__default__=e}return this._graphDrag=new joint.dia.Graph,this._paperDrag=new joint.dia.Paper({el:this.$paperDrag,width:1,height:1,model:this._graphDrag}),_.each(this.papers,function(a){this.listenTo(a,"cell:pointerdown",this.onDragStart)},this),this},load:function(a,b){var c=this.graphs[b||"__default__"];if(!c)throw new Error("Stencil: group "+b+" does not exist.");c.resetCells(a);var d=this.options.height;b&&this.options.groups[b]&&(d=this.options.groups[b].height),d||this.papers[b||"__default__"].fitToContent(1,1,this.options.paperPadding||10)},getGraph:function(a){return this.graphs[a||"__default__"]},getPaper:function(a){return this.papers[a||"__default__"]},onDragStart:function(a,b){b.preventDefault(),this.options.graph.trigger("batch:start",{batchName:"stencil-drag"}),this.$el.addClass("dragging"),this._paperDrag.$el.addClass("dragging"),$(document.body).append(this._paperDrag.$el),this._clone=a.model.clone(),this._cloneBbox=a.getBBox();var c=5,d=g.point(this._cloneBbox.x-this._clone.get("position").x,this._cloneBbox.y-this._clone.get("position").y);this._clone.set("position",{x:-d.x+c,y:-d.y+c}).addTo(this._graphDrag),this._cloneView=this._clone.findView(this._paperDrag),this._clonePosition=_.clone(this._clone.position()),this._paperDrag.setDimensions(this._cloneBbox.width+2*c,this._cloneBbox.height+2*c);var e=document.body.scrollTop||document.documentElement.scrollTop;this._paperDragOriginalOffset={left:b.clientX-this._cloneBbox.width/2,top:b.clientY+e-this._cloneBbox.height/2},this._paperDrag.$el.offset(this._paperDragOriginalOffset)},onDrag:function(a){if(this._clone){a.preventDefault(),a=joint.util.normalizeEvent(a);var b=document.body.scrollTop||document.documentElement.scrollTop,c=a.clientX-this._cloneBbox.width/2,d=a.clientY+b-this._cloneBbox.height/2;if(this._paperDrag.$el.offset({left:c,top:d}),this.options.paper.options.embeddingMode&&this._cloneView){var e=this.options.paper.clientToLocalPoint({x:c,y:d});e.x+=this._clonePosition.x,e.y+=this._clonePosition.y,this._clone.set("position",e,{silent:!0}),this._cloneView.processEmbedding({model:this._clone,paper:this.options.paper})}}},onDragEnd:function(a){if(this._clone&&this._cloneBbox){a=joint.util.normalizeEvent(a),this._clone.set("position",this._clonePosition,{silent:!0});var b=this._clone.clone(),c=this.drop(a,b,this._cloneBbox);if(c||this.trigger("drop:invalid",a,b),!c&&this.options.dropAnimation){var d=_.isObject(this.options.dropAnimation)?this.options.dropAnimation.duration:150,e=_.isObject(this.options.dropAnimation)?this.options.dropAnimation.easing:"swing";this._paperDrag.$el.animate(this._paperDragOriginalOffset,d,e,this.onDropEnd)}else this.onDropEnd();this.options.paper.options.embeddingMode&&this._cloneView&&this._cloneView.finalizeEmbedding({model:b,paper:this.options.paper}),this.options.graph.trigger("batch:stop",{batchName:"stencil-drag"})}},onDropEnd:function(){this.$el.append(this._paperDrag.$el),this.$el.removeClass("dragging"),this._paperDrag.$el.removeClass("dragging"),this._clone.remove(),this._clone=void 0},insideValidArea:function(a){var b,c=this.options.paper,d=this.options.paperScroller,e=this.getDropArea(this.$el);if(d)if(d.options.autoResizePaper)b=this.getDropArea(d.$el);else{var f=this.getDropArea(d.$el),g=this.getDropArea(c.$el);b=g.intersect(f)}else b=this.getDropArea(c.$el);return!(!b||!b.containsPoint(a)||e.containsPoint(a))},getDropArea:function(a){var b=a.offset(),c=document.body.scrollTop||document.documentElement.scrollTop,d=document.body.scrollLeft||document.documentElement.scrollLeft;return g.rect({x:b.left+parseInt(a.css("border-left-width"),10)-d,y:b.top+parseInt(a.css("border-top-width"),10)-c,width:a.innerWidth(),height:a.innerHeight()})},drop:function(a,b,c){var d=this.options.paper,e=this.options.graph,f=(document.body.scrollTop||document.documentElement.scrollTop,document.body.scrollLeft||document.documentElement.scrollLeft,{x:a.clientX,y:a.clientY});if(this.insideValidArea(f)){var h=d.clientToLocalPoint(f),i=b.getBBox();return h.x+=i.x-c.width/2,h.y+=i.y-c.height/2,b.set("position",{x:g.snapToGrid(h.x,d.options.gridSize),y:g.snapToGrid(h.y,d.options.gridSize)}),b.unset("z"),e.addCell(b,{stencil:this.cid}),!0}return!1},filter:function(a,b){var c=a.toLowerCase()==a,d=_.reduce(this.papers,function(d,e,f){var g=e.model.get("cells").filter(function(d){var f=e.findViewByModel(d),g=!a||_.some(b,function(b,e){if("*"!=e&&d.get("type")!=e)return!1;var f=_.some(b,function(b){var e=joint.util.getByPath(d.attributes,b,"/");return _.isUndefined(e)||_.isNull(e)?!1:(e=e.toString(),c&&(e=e.toLowerCase()),e.indexOf(a)>=0)});return f});return V(f.el).toggleClass("unmatched",!g),g},this),h=!_.isEmpty(g),i=(new joint.dia.Graph).resetCells(g);return this.trigger("filter",i,f),this.$groups[f]&&this.$groups[f].toggleClass("unmatched",!h),e.fitToContent(1,1,this.options.paperPadding||10),d||h},!1,this);this.$el.toggleClass("not-found",!d)},onSearch:function(a){this.filter(a.target.value,this.options.search)},onGroupLabelClick:function(a){a.preventDefault();var b=$(a.target).closest(".group");this.toggleGroup(b.data("name"))},toggleGroup:function(a){this.$('.group[data-name="'+a+'"]').toggleClass("closed")},closeGroup:function(a){this.$('.group[data-name="'+a+'"]').addClass("closed")},openGroup:function(a){this.$('.group[data-name="'+a+'"]').removeClass("closed")},closeGroups:function(){this.$(".group").addClass("closed")},openGroups:function(){this.$(".group").removeClass("closed")},onRemove:function(){_.invoke(this.papers,"remove"),this.papers={},this._paperDrag&&(this._paperDrag.remove(),this._paperDrag=null),$(document.body).off(".stencil",this.onDrag).off(".stencil",this.onDragEnd)}});