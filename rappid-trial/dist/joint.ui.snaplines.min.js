/*! Rappid v1.7.1 - HTML5 Diagramming Framework - TRIAL VERSION

Copyright (c) 2015 client IO

 2016-03-03 


This Source Code Form is subject to the terms of the Rappid Trial License
, v. 2.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_v2.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.ui.Snaplines=joint.mvc.View.extend({options:{paper:void 0,distance:10},className:"snaplines",init:function(){_.bindAll(this,"hide"),this.$horizontal=$("<div>").addClass("snapline horizontal").appendTo(this.el),this.$vertical=$("<div>").addClass("snapline vertical").appendTo(this.el),this.$el.hide().appendTo(this.options.paper.el),this.startListening()},startListening:function(){this.stopListening(),this.listenTo(this.options.paper,"cell:pointerdown",this.captureCursorOffset),this.listenTo(this.options.paper,"cell:pointermove",this.snapWhileMoving),this.listenTo(this.options.paper.model,"batch:stop",this.onBatchStop),$(document).on("mouseup",this.hide),this.filterTypes={},this.filterCells={},this.filterFunction=void 0,_.isArray(this.options.filter)?_.each(this.options.filter,function(a){_.isString(a)?this.filterTypes[a]=!0:this.filterCells[a.id]=!0},this):_.isFunction(this.options.filter)&&(this.filterFunction=this.options.filter)},onBatchStop:function(a){a=a||{},"resize"===a.batchName&&this.snapWhileResizing(a.element,a)},captureCursorOffset:function(a,b,c,d){if(!(a instanceof joint.dia.LinkView)){var e=a.model.get("position");this._cursorOffset={x:c-e.x,y:d-e.y}}},snapWhileResizing:function(a,b){if(b.ui&&!b.snapped&&b.direction&&b.trueDirection){var c=this.options.paper.findViewByModel(a);if(!(c instanceof joint.dia.LinkView)){var d=a.getBBox(),e=d.bbox(a.get("angle")),f=e.origin(),h=e.corner(),i=g.normalizeAngle(a.get("angle")),j=this.options.distance,k=null,l=null,m={vertical:0,horizontal:0};if(-1!==b.trueDirection.indexOf("right")?m.vertical=h.x:m.vertical=f.x,-1!==b.trueDirection.indexOf("bottom")?m.horizontal=h.y:m.horizontal=f.y,_.find(this.options.paper.model.getElements(),function(b){if(b.id===a.id||b.isEmbeddedIn(a)||this.filterTypes[b.get("type")]||this.filterCells[b.id]||this.filterFunction&&this.filterFunction(b))return!1;var c=b.getBBox().bbox(b.get("angle")),d=c.origin(),e=c.corner(),f={vertical:[d.x,e.x],horizontal:[d.y,e.y]};return _.each(f,function(a,b){a=_.map(a,function(a){return{position:a,distance:Math.abs(a-m[b])}}),a=_.filter(a,function(a){return a.distance<j}),a=_.sortBy(a,function(a,b){return a.distance>b.distance?1:a.distance===b.distance?0:-1}),f[b]=a}),_.isNull(k)&&f.vertical.length>0&&(k=f.vertical[0].position),_.isNull(l)&&f.horizontal.length>0&&(l=f.horizontal[0].position),_.isNumber(k)&&_.isNumber(l)},this),this.hide(),_.isNumber(k)||_.isNumber(l)){var n=0;_.isNumber(k)&&(n=-1!==b.trueDirection.indexOf("right")?k-e.corner().x:e.origin().x-k);var o=0;_.isNumber(l)&&(o=-1!==b.trueDirection.indexOf("bottom")?l-e.corner().y:e.origin().y-l);var p,q=0,r=0,s=i%90,t=!(i%90);if(p=i>=0&&90>i?1:i>=90&&180>i?4:i>=180&&270>i?3:2,t)90===i||270===i?(q=o,r=n):(q=n,r=o);else{var u=g.toRad(s);l&&k&&(o>n?(o=0,l=null):(n=0,k=null)),n&&(q=3===p?n/Math.cos(u):n/Math.sin(u)),o&&(r=3===p?o/Math.cos(u):o/Math.sin(u));var v=1===p||3===p;switch(b.relativeDirection){case"top":case"bottom":r=o?o/(v?Math.cos(u):Math.sin(u)):n/(v?Math.sin(u):Math.cos(u));break;case"left":case"right":q=n?n/(v?Math.cos(u):Math.sin(u)):o/(v?Math.sin(u):Math.cos(u))}}switch(b.relativeDirection){case"top":case"bottom":q=0;break;case"left":case"right":r=0}var w=d.width+q,x=d.height+r;a.resize(w,x,{restrictedArea:this.options.paper.getRestrictedArea(c),snapped:!0,direction:b.direction,relativeDirection:b.relativeDirection,trueDirection:b.trueDirection}),this.show({vertical:k,horizontal:l})}}}},snapWhileMoving:function(a,b,c,d){if(!(a instanceof joint.dia.LinkView)){var e=a.model,f=e.get("position"),h=e.get("size"),i=g.rect(_.extend({x:c-this._cursorOffset.x,y:d-this._cursorOffset.y},h)),j=i.center(),k=i.bbox(e.get("angle")),l=k.origin(),m=k.corner(),n=this.options.distance,o=null,p=null,q=0,r=0;if(_.find(this.options.paper.model.getElements(),function(a){if(a===e||a.isEmbeddedIn(e)||this.filterTypes[a.get("type")]||this.filterCells[a.id]||this.filterFunction&&this.filterFunction(a))return!1;var b=a.getBBox().bbox(a.get("angle")),c=b.center(),d=b.origin(),f=b.corner();return _.isNull(o)&&(Math.abs(c.x-j.x)<n?(o=c.x,q=.5):Math.abs(d.x-l.x)<n?o=d.x:Math.abs(d.x-m.x)<n?(o=d.x,q=1):Math.abs(f.x-m.x)<n?(o=f.x,q=1):Math.abs(f.x-l.x)<n&&(o=f.x)),_.isNull(p)&&(Math.abs(c.y-j.y)<n?(p=c.y,r=.5):Math.abs(d.y-l.y)<n?p=d.y:Math.abs(d.y-m.y)<n?(p=d.y,r=1):Math.abs(f.y-m.y)<n?(p=f.y,r=1):Math.abs(f.y-l.y)<n&&(p=f.y)),_.isNumber(o)&&_.isNumber(p)},this),this.hide(),_.isNumber(o)||_.isNumber(p)){_.isNumber(o)&&(k.x=o-q*k.width),_.isNumber(p)&&(k.y=p-r*k.height);var s=k.center(),t=s.x-i.width/2,u=s.y-i.height/2;e.translate(t-f.x,u-f.y,{restrictedArea:this.options.paper.getRestrictedArea(a),snapped:!0}),this.show({vertical:o,horizontal:p})}}},show:function(a){a=a||{};var b=this.options.paper.viewport.getCTM();a.horizontal?this.$horizontal.css("top",a.horizontal*b.d+b.f).show():this.$horizontal.hide(),a.vertical?this.$vertical.css("left",a.vertical*b.a+b.e).show():this.$vertical.hide(),this.$el.show()},hide:function(){this.$el.hide()},onRemove:function(){$(document).off("mouseup",this.hide)}});